# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)
# and commit this file to your remote git repository to share the goodness with others.

image:
  file: .gitpod.Dockerfile

tasks:

  - name: Geo Distributed Cluster
    env: 
      US_REGION_ZONE_A_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=us-west-1,placement_zone=us-west-1a"
      US_REGION_ZONE_B_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=us-west-1,placement_zone=us-west-1b"
      US_REGION_ZONE_C_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=us-west-1,placement_zone=us-west-1c"

      EU_REGION_ZONE_A_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=eu-west-1,placement_zone=eu-west-1a"
      EU_REGION_ZONE_B_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=eu-west-1,placement_zone=eu-west-1b"
      EU_REGION_ZONE_C_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=eu-west-1,placement_zone=eu-west-1c"
      
      AP_REGION_ZONE_A_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=ap-south-1,placement_zone=ap-south-1a"
      AP_REGION_ZONE_B_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=ap-south-1,placement_zone=ap-south-1b"
      AP_REGION_ZONE_C_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=ap-south-1,placement_zone=ap-south-1c"
      MODIFY_PLACEMENT_STRING: aws.us-west-1.us-west-1a,aws.us-west-1.us-west-1b,aws.us-west-1.us-west-1c,aws.eu-west-1.eu-west-1a,aws.eu-west-1.eu-west-1b,
        aws.eu-west-1.eu-west-1c,aws.ap-south-1.ap-south-1a,aws.ap-south-1.ap-south-1b,aws.ap-south-1.ap-south-1c, 
      
      REPLICATION_FACTOR: 3   
    command: |
      yugabyted start --base_dir=$STORE/ybd1 --listen=127.0.0.1 \
        --tserver_flags=$US_REGION_ZONE_A_NODE_PLACEMENT_INFO --master_flags=$US_REGION_ZONE_A_NODE_PLACEMENT_INFO
      yugabyted start --base_dir=$STORE/ybd2 --listen=127.0.0.2 \
        --tserver_flags=$US_REGION_ZONE_B_NODE_PLACEMENT_INFO --master_flags=$US_REGION_ZONE_B_NODE_PLACEMENT_INFO
      yugabyted start --base_dir=$STORE/ybd3 --listen=127.0.0.3 \
        --tserver_flags=$US_REGION_ZONE_C_NODE_PLACEMENT_INFO --master_flags=$US_REGION_ZONE_C_NODE_PLACEMENT_INFO                 
      
      yugabyted start --base_dir=$STORE/ybd4 --listen=127.0.0.4 --join=127.0.0.1 \
        --tserver_flags=$EU_REGION_ZONE_A_NODE_PLACEMENT_INFO --master_flags=$EU_REGION_ZONE_A_NODE_PLACEMENT_INFO
      yugabyted start --base_dir=$STORE/ybd5 --listen=127.0.0.5 --join=127.0.0.1 \
        --tserver_flags=$EU_REGION_ZONE_B_NODE_PLACEMENT_INFO --master_flags=$EU_REGION_ZONE_B_NODE_PLACEMENT_INFO
      yugabyted start --base_dir=$STORE/ybd6 --listen=127.0.0.6 --join=127.0.0.1 \
        --tserver_flags=$EU_REGION_ZONE_C_NODE_PLACEMENT_INFO --master_flags=$EU_REGION_ZONE_C_NODE_PLACEMENT_INFO

      yugabyted start --base_dir=$STORE/ybd7 --listen=127.0.0.7 --join=127.0.0.1 \
        --tserver_flags=$AP_REGION_ZONE_A_NODE_PLACEMENT_INFO --master_flags=$AP_REGION_ZONE_A_NODE_PLACEMENT_INFO
      yugabyted start --base_dir=$STORE/ybd8 --listen=127.0.0.8 --join=127.0.0.1 \
        --tserver_flags=$AP_REGION_ZONE_B_NODE_PLACEMENT_INFO --master_flags=$AP_REGION_ZONE_B_NODE_PLACEMENT_INFO
      yugabyted start --base_dir=$STORE/ybd9 --listen=127.0.0.9 --join=127.0.0.1 \
        --tserver_flags=$AP_REGION_ZONE_C_NODE_PLACEMENT_INFO --master_flags=$AP_REGION_ZONE_C_NODE_PLACEMENT_INFO

      yb-admin -master_addresses 127.0.0.1:7100,127.0.0.2:7100,127.0.0.3:7100,127.0.0.4:7100,127.0.0.5:7100 \
        modify_placement_info $MODIFY_PLACEMENT_STRING $REPLICATION_FACTOR

      gp sync-done geo-distributed-cluster-ready

  - name: Geo Cluster Shell
    command: |
      gp sync-await geo-distributed-cluster-ready
      ysqlsh -f /workspace/corporate-messenger/data/profile_service_schema.sql
      ysqlsh -f /workspace/corporate-messenger/data/messaging_service_schema.sql
      ysqlsh -h 127.0.0.1
    openMode: split-right

  - name: Next.js Server
    init: npm instal
    command: npm run dev
    openMode: split-right   

ports:
  - port: 3000
    visibility: public
    onOpen: notify