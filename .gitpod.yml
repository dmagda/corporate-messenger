# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/config-gitpod-file)
# and commit this file to your remote git repository to share the goodness with others.

image:
  file: .gitpod.Dockerfile

tasks:
  - name: Next.js Server
    init: npm instal
    command: npm run dev
    openMode: split-right 

  # - name: Cluster#1 (Geo-Distributed)
  #   env: 
  #     US_REGION_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=us-west-1,placement_zone=us-west-1a"
  #     EU_REGION_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=eu-west-1,placement_zone=eu-west-1a"
  #     AP_REGION_NODE_PLACEMENT_INFO: "placement_cloud=aws,placement_region=ap-south-1,placement_zone=ap-south-1a"
  #     MODIFY_PLACEMENT_STRING: aws.us-west-1.us-west-1a,aws.eu-west-1.eu-west-1a,aws.ap-south-1.ap-south-1a
  #     REPLICATION_FACTOR: 3   
  #   command: |
  #     yugabyted start --base_dir=$STORE/ybd1 --listen=127.0.0.1 \
  #       --tserver_flags=$US_REGION_NODE_PLACEMENT_INFO --master_flags=$US_REGION_NODE_PLACEMENT_INFO
      
  #     yugabyted start --base_dir=$STORE/ybd2 --listen=127.0.0.2 --join=127.0.0.1 \
  #       --tserver_flags=$EU_REGION_NODE_PLACEMENT_INFO --master_flags=$EU_REGION_NODE_PLACEMENT_INFO

  #     yugabyted start --base_dir=$STORE/ybd3 --listen=127.0.0.3 --join=127.0.0.1 \
  #       --tserver_flags=$AP_REGION_NODE_PLACEMENT_INFO --master_flags=$AP_REGION_NODE_PLACEMENT_INFO

  #     yb-admin -master_addresses 127.0.0.1:7100,127.0.0.2:7100,127.0.0.3:7100 \
  #       modify_placement_info $MODIFY_PLACEMENT_STRING $REPLICATION_FACTOR

  #     gp sync-done geo-distributed-cluster-ready

  # - name: Cluster#1 Shell
  #   command: |
  #     gp sync-await geo-distributed-cluster-ready
  #     ysqlsh -h 127.0.0.1
  #   openMode: split-right

  - name: Cluster#2 (Read Replicas)
    env: 
      PRIMARY_NODE_IP: 127.0.0.4
      EU_REPLICA_NODE_IP: 127.0.0.5
      AP_REPLICA_NODE_IP: 127.0.0.6
      PRIMARY_CLUSTER_UUID: primary_cluster
      REPLICA_CLUSTER_UUID: read_replica  
    command: |
      gp sync-await geo-distributed-cluster-ready
       
      yb-master --master_addresses $PRIMARY_NODE_IP:7100 --rpc_bind_addresses $PRIMARY_NODE_IP:7100 --fs_data_dirs $STORE/ybd4

      yb-admin -master_addresses $PRIMARY_NODE_IP:7100 modify_placement_info aws.us-west-1.us-west-1a 1 $PRIMARY_CLUSTER_UUID

      yb-admin -master_addresses $PRIMARY_NODE_IP:7100 \
        add_read_replica_placement_info aws.eu-west-1.eu-west-1a:1,aws.ap-south-1.ap-south-1a:1 2 $REPLICA_CLUSTER_UUID

      yb-tserver --tserver_master_addrs $PRIMARY_NODE_IP:7100 --rpc_bind_addresses $PRIMARY_NODE_IP:9100 \
        --start_pgsql_proxy --pgsql_proxy_bind_address $PRIMARY_NODE_IP:5433 --cql_proxy_bind_address $PRIMARY_NODE_IP:9042 \
        --fs_data_dirs $STORE/ybd4 --placement_cloud aws --placement_region us-west-1 --placement_zone us-west-1a --placement_uuid $PRIMARY_CLUSTER_UUID

      yb-tserver --tserver_master_addrs $PRIMARY_NODE_IP:7100 --rpc_bind_addresses $EU_REPLICA_NODE_IP:9100 \
        --start_pgsql_proxy --pgsql_proxy_bind_address $EU_REPLICA_NODE_IP:5433 --cql_proxy_bind_address $EU_REPLICA_NODE_IP:9042 \
        --fs_data_dirs $STORE/ybd5 --placement_cloud aws --placement_region eu-west-1 --placement_zone eu-west-1a --placement_uuid $REPLICA_CLUSTER_UUID

      yb-tserver --tserver_master_addrs $PRIMARY_NODE_IP:7100 --rpc_bind_addresses $AP_REPLICA_NODE_IP:9100 \
        --start_pgsql_proxy --pgsql_proxy_bind_address $AP_REPLICA_NODE_IP:5433 --cql_proxy_bind_address $AP_REPLICA_NODE_IP:9042 \
        --fs_data_dirs $STORE/ybd6 --placement_cloud aws --placement_region ap-south-1 --placement_zone ap-south-1a --placement_uuid $REPLICA_CLUSTER_UUID
    
      gp sync-done cluster-with-read-replicas-ready

  - name: Cluster#2 Shell (Primary)
    command: |
      gp sync-await cluster-with-read-replicas-ready
      ysqlsh -h 127.0.0.4
    openMode: split-right    

ports:
  - port: 3000
    visibility: public
    onOpen: notify